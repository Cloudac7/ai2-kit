# CLL MLP Training Workflow

```bash
ai2-kit workflow cll-mlp-training
```

## Introduction

The CCL-MLP workflow employs the Closed-Loop Learning pattern for automatic training of MLP models. In each iteration, the workflow employs labeled structures generated by first-principle methods to train multiple MLP models. These models are then utilized to explore new structures as training data for the subsequent iteration. The iterations continue until the quality of MLP models satisfies the predetermined criteria. The configuration of each iteration can be dynamically updated to further enhance the efficiency of training.

![cll-mlp-diagram](../res/cll-mlp-diagram.svg)

## Usage
TODO

## Example

```yaml
executors:
  ikkem:
    ssh:
      host: user@hpc-cluster
    queue_system:
      slurm: {}
    work_dir: /home/user1/cll-workdir
    python_cmd: python3

    context:
      train:
        deepmd:
          script_template:
            header: |
              #SBATCH -N 1
              #SBATCH --ntasks-per-node=8
              #SBATCH --job-name=deepmd
              #SBATCH --partition=GPU_s_cg
              #SBATCH --gres=gpu:1
            setup: |
              set -e
              module load anaconda/2022.5
              source activate deepmd-2.1.5-gpu
              set +e

      explore:
        lammps:
          script_template:
            header: |
              #SBATCH -N 1
              #SBATCH --ntasks-per-node=4
              #SBATCH --job-name=lammps
              #SBATCH --partition=GPU_s_cg
              #SBATCH --gres=gpu:1
            setup: |
              set -e
              module load anaconda/2022.5
              source activate deepmd-2.1.5-gpu
              set +e

      label:
        cp2k:
          cp2k_cmd: mpirun cp2k.popt
          script_template:
            header: |
              #SBATCH -N 5
              #SBATCH --ntasks-per-node=28
              #SBATCH -t 12:00:00
              #SBATCH --job-name=cp2k
              #SBATCH --partition=medium_s_cg

            setup: |
              set -e
              module load mkl/2021.1.1
              module load mpi/openmpi/4.0.3-gcc
              module load cp2k/8.2-intel
              set +e

artifacts:
  train/h3o:
    url: /public/groups/chenggroup/sample-data/wf-water/00.init_data/system-000

  train/oh:
    url: /public/groups/chenggroup/sample-data/wf-water/00.init_data/system-001

  train/h2o:
    url: /public/groups/chenggroup/sample-data/wf-water/00.init_data/system-002

  explore/h2o_64:
    url: /public/groups/chenggroup/sample-data/wf-water/01.md_init/h2o_64
    includes: POSCAR*
    attrs:
      label-cp2k:
        input_tempate:
          charge: 0
          uks: false

  explore/h2o_128:
    url: /public/groups/chenggroup/sample-data/wf-water/01.md_init/h2o_128
    includes: POSCAR*
    attrs:
      explore-lammps:
        E_a: 100

  explore/h3o_64:
    url: /public/groups/chenggroup/sample-data/wf-water/01.md_init/h3o_64
    includes: POSCAR*

  explore/h3o_128:
    url: /public/groups/chenggroup/sample-data/wf-water/01.md_init/h3o_128
    includes: POSCAR*

  explore/oh_64:
    url: /public/groups/chenggroup/sample-data/wf-water/01.md_init/oh_64
    includes: POSCAR*

  explore/oh_128:
    url: /public/groups/chenggroup/sample-data/wf-water/01.md_init/oh_128
    includes: POSCAR*

  cp2k/basic_set:
    url: /public/groups/chenggroup/sample-data/cp2k/BASIS_MOLOPT
  cp2k/potential:
    url: /public/groups/chenggroup/sample-data/cp2k/GTH-SCAN-POTENTIAL

workflow:

  general:
    type_map: [ O, H ]
    mass_map: [ 15.999, 1.0080 ]

  train:
    deepmd:
      model_num: 4
      init_dataset : [train/h2o, train/h3o, train/oh]

      input_template:
        model:
          descriptor:
            type: se_a
            sel: [50, 100]
            rcut_smth: 0.5
            rcut: 6.0
            neuron: [25, 50, 100]
            resnet_dt: false
            axis_neuron: 16
            seed: 1
          fitting_net:
            neuron: [240, 240, 240]
            resnet_dt: true
            seed: 1
        learning_rate:
          type: exp
          start_lr: 0.001
          decay_steps: 2000
          decay_rate: 0.95
        loss:
          start_pref_e: 0.02
          limit_pref_e: 1
          start_pref_f: 1000
          limit_pref_f: 1
          start_pref_v: 0
          limit_pref_v: 0
        training:
          stop_batch: 200000
          seed: 1
          disp_freq: 100
          numb_test: 10
          save_freq: 1000
          disp_training: true
          time_training: true
          profiling: false

  explore:
    lammps:
      tau_t: 0.1
      tau_p: 0.5
      timestep: 0.0005
      sample_freq: 100
      nsteps: 12000
      ensemble: nvt

      post_init_section: |
        neighbor   1.0 bin
        box        tilt large

      post_read_data_section: |
        change_box all triclinic

      system_files: [explore/h2o_64, explore/h3o_64]
      explore_vars:
        temp: [330, 430, 530]
        pres: [1, 2]

  select:
    by_threshold:
      f_trust_lo: 0.08
      f_trust_hi: 0.14

  update:
    walkthrough:
      table:
        - train:
            deepmd:
              model_num: 4
          explore:
            lammps:
              system_files: [explore/h2o_128]
              explore_vars:
                temp: [ 330, 430, 530 ]

        - train:
            deepmd:
              model_num: 4
          explore:
            lammps:
              system_files: [explore/h2o_128]
              explore_vars:
                temp: [ 330, 430, 530 ]

  label:
    cp2k:
      limit: 10
      input_template:
        GLOBAL:
          PROJECT_NAME: AI2-KIT
          PREFERRED_DIAG_LIBRARY: ELPA
          EXTENDED_FFT_LENGTHS: true
        FORCE_EVAL:
          DFT:
            BASIS_SET_FILE_NAME: '@cp2k/basic_set'
            POTENTIAL_FILE_NAME: '@cp2k/potential'
            MGRID:
              CUTOFF: 900
              REL_CUTOFF: 90
              NGRIDS: 4
            QS:
              EPS_DEFAULT: 1.0e-13
              EXTRAPOLATION: ASPC
              EXTRAPOLATION_ORDER: 2
            SCF:
              OUTER_SCF:
                EPS_SCF: 3.0e-07
                MAX_SCF: 50
              OT:
                MINIMIZER: CG
                PRECONDITIONER: FULL_SINGLE_INVERSE
                ENERGY_GAP: 0.1
              SCF_GUESS: RESTART
              EPS_SCF: 3.0e-07
              MAX_SCF: 20
            XC:
              XC_FUNCTIONAL:
                LIBXC:
                - FUNCTIONAL: MGGA_C_R2SCAN
                - FUNCTIONAL: MGGA_X_R2SCAN
            CHARGE: 0
            UKS: false
            MULTIPLICITY: 1
          SUBSYS:
            KIND:
              H:
                BASIS_SET: TZVP-MOLOPT-GTH
                POTENTIAL: GTH-SCAN-q1
              O:
                BASIS_SET: TZVP-MOLOPT-GTH
                POTENTIAL: GTH-SCAN-q6
          PRINT:
            FORCES:
              _: 'ON'
            STRESS_TENSOR:
              _: 'ON'
          METHOD: QS
          STRESS_TENSOR: ANALYTICAL
```
